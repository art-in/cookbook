<link rel="import" href="/polymer/polymer.html">
<link rel="import" href="recipe-card-min.html">

<dom-module id="recipe-card">
    <style>

    </style>
    <template>
        <div id="modal-element-id" class="modal">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="pull-right">
                            <button type="button" class="btn btn-default"
                                    (click)="onEdit()" *ngIf="!inEditMode && recipeId !== '_NEW_'">
                                <span class="glyphicon glyphicon-pencil"></span>
                            </button>
                            <button type="button" class="btn btn-default"
                                    (click)="onSave()" *ngIf="inEditMode || recipeId === '_NEW_'">
                                <span class="glyphicon glyphicon-save"></span>
                            </button>
                            <button type="button" class="btn btn-default"
                                    (click)="onCancel()" *ngIf="inEditMode && recipeId !== '_NEW_'">
                                <span class="glyphicon glyphicon-erase"></span>
                            </button>
                            <button type="button" class="btn btn-default"
                                    (click)="onDelete()" *ngIf="recipeId !== '_NEW_'">
                                <span class="glyphicon glyphicon-trash"></span>
                            </button>
                            <button type="button" class="btn btn-default"
                                data-dismiss="modal"
                                on-click="onClose">
                                <span class="glyphicon glyphicon-remove"></span>
                            </button>
                        </div>
                    </div>
                    <div class="modal-body">
                        <recipe-card-min class="row"
                                        *ngIf="recipe"
                                        descriptionRowsCount="5"
                                        recipe="{{recipe}}"
                                        [deletable]="false"
                                        [editable]="inEditMode || recipeId === '_NEW_'"
                                        [focusName]="recipeId === '_NEW_'">
                        </recipe-card-min>

                        <div class="row">
                            <div class="col-md-offset-3 col-sm-offset-4
                                        col-md-9 col-sm-8 col-xs-12">
                                <list class="ingredients"
                                    *ngIf="recipe"
                                    title="Ингредиенты"
                                    [items]="recipe.Ingredients"
                                    [editable]="inEditMode || recipeId === '_NEW_'"
                                    [deletable]="inEditMode || recipeId === '_NEW_'"
                                    [sortable]="false"
                                    [ordered]="false">
                                </list>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-offset-3 col-sm-offset-4
                                        col-md-9 col-sm-8 col-xs-12">
                                <list *ngIf="recipe"
                                    title="Шаги"
                                    [items]="recipe.Steps"
                                    [editable]="inEditMode || recipeId === '_NEW_'"
                                    [deletable]="inEditMode || recipeId === '_NEW_'"
                                    [sortable]="true"
                                    [ordered]="true">
                                </list>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: 'recipe-card',
            properties: {
                recipe: Object
            },
            attached() {
                this.$modal = $(this.$['modal-element-id']);

                // on background click
                this.$modal.on('hide.bs.modal', () => {
                    this.onClose();
                });

                this.$modal.on('shown.bs.modal', function () {
                    // bootstap does not support jquery > 3,
                    // jq changed the way .show() works
                    // so we need this workaround
                    this.$modal.css('display', 'block');
                }.bind(this));

                // show modal
                // bootstrap-jquery api - is only reason for direct DOM access.
                // bootstrap-attribute api will not work for startup popup from route
                this.$modal.modal('show');

                window.addEventListener('beforeunload', this.onWindowBeforeUnloadBound);
            },

            onClose() {
                this.fire('close');
            }
        });
    </script>
</dom-module>